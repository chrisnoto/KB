# 负责查询
 (|(!(gidNumber=*))(!(mail=*)))
 (!(employeeType=*))
 (&(uid=*)(lastlogintime>=20221127000000Z))

(|(!(gidNumber=*))(!(mail=*)))(!(employeeType=*))(&(uid=*)(lastlogintime>=20221127000000Z)) 
 
# 修改binddn的查找条目数限制
dn: uid=sso,ou=user,ou=system,dc=cesbg,dc=fii
changetype: modify
add: nssizelimit
nssizelimit: -1
-
add: nslookthroughlimit
nslookthroughlimit: -1

#创建OU
ldapadd -x -W -D "cn=Directory Manager" -f ou.ldif

dn: ou=system,dc=cesbg,dc=fii
changetype: add
objectClass: top
objectClass: organizationalUnit
description: 用户
ou:system

dn: ou=user,ou=system,dc=cesbg,dc=fii
changetype: add
objectClass: top
objectClass: organizationalUnit
description: 用户
ou:user

# 创建账号
ldapadd -x -W -D "cn=Directory Manager" -f user.ldif

dn: uid=nextcloud,ou=user,ou=system,dc=cesbg,dc=fii
objectClass: top
objectClass: person
objectClass: organizationalPerson
objectClass: inetorgperson
objectClass: posixAccount
homeDirectory: /var/empty
modifiersname:cn=directory manager
cn: nextcloud
sn: nextcloud
uid: nextcloud
givenname: nextcloud
userPassword: Foxconn456&*(
gidnumber:1
uidNumber: 201
displayName: nextcloud

dn: uid=sso,ou=user,ou=system,dc=cesbg,dc=fii
objectClass: top
objectClass: person
objectClass: organizationalPerson
objectClass: inetorgperson
objectClass: posixAccount
homeDirectory: /var/empty
modifiersname:cn=directory manager
cn: sso
sn: sso
uid: sso
givenname: sso
userPassword: Foxconn456&*(
gidnumber:1
uidNumber: 202
displayName:sso

# 给用户赋权限
ldapmodify -x -W -D "cn=Directory Manager" -f permission.ldif
文件内容
dn: cn=configuration administrators,ou=groups,ou=topologymanagement,o=netscaperoot
changetype: modify
add: uniqueMember
uniqueMember:  uid=IG1527,ou=user,ou=foxconn,dc=dms,dc=foxconn
 
dn: cn=configuration administrators,ou=groups,ou=topologymanagement,o=netscaperoot
changetype: modify
add: uniqueMember
uniqueMember: uid=F2147826,ou=user,ou=foxconn,dc=dms,dc=foxconn 

# 删除用户的属性
dn:uid=nextcloud,ou=user,ou=system,dc=cesbg,dc=fii
changetype: modify
delete:passwordRetryCount
-
delete:accountUnlockTime

# reindex操作
dsconf -D "cn=Directory Manager" ldap://XTJJSLdap01.cesbg.fii backend index reindex --wait --attr=gidnumber dc=cesbg,dc=fii

### time-based account lockout policies
1 启用基于时间的账号锁定策略插件
dsconf -D "cn=Directory Manager" ldap://XTJJSLdap01.cesbg.fii plugin account-policy enable

2 增加插件配置
dsconf -D "cn=Directory Manager" ldap://XTJJSLdap01.cesbg.fii plugin account-policy \
config-entry add "cn=config,cn=Account Policy Plugin,cn=plugins,cn=config" \
--always-record-login yes \
--state-attr lastLoginTime \
--alt-state-attr createtimestamp \
--spec-attr acctPolicySubentry \
--limit-attr accountInactivityLimit

3 重启实例使插件生效

4 在OU=Foxconn里建立账户不活跃策略，定义了accountInactivityLimit:2592000
ldapadd -x -ZZ -W -D "cn=Directory Manager" -f

dn: cn=Account Inactivation Policy,ou=Foxconn,dc=cesbg,dc=fii
objectClass: top
objectClass: ldapsubentry
objectClass: extensibleObject
objectClass: accountpolicy
accountInactivityLimit:2592000
cn: Account Inactivation Policy

/*  每个服务定义(COS)都由目录中的两类条目组成，COS定义条目和模板条目 */
/* COS的作用是逻辑生成一些属性给指定范围内的entry(dn),减少存储在每个entry里的属性值，对应用透明*/
/* COS提供的是虚拟的属性*/
/* Classes of service use one entry as a template; whenever that attribute value changes, 
then all other entries within the scope of the CoS automatically have the same attribute on their entries changed. 
(The entries affected by the CoS are identified through a definition entry.)*/

5 在OU=Foxconn里建立模板条目，这个模板条目
定义了键值对 acctPolicySubentry: cn=Account Inactivation Policy,ou=Foxconn,dc=cesbg,dc=fii
从而关联上面的account inactivation policy

ldapadd -x -ZZ -W -D "cn=Directory Manager" -f zjmb.ldif

dn: cn=TempltCoS,ou=Foxconn,dc=cesbg,dc=fii
objectClass: top
objectClass: ldapsubentry
objectClass: extensibleObject
objectClass: cosTemplate
acctPolicySubentry: cn=Account Inactivation Policy,ou=Foxconn,dc=cesbg,dc=fii

6 在OU=Foxconn里建立定义条目，首先定义了它是pointer类型的COS, 然后关联模板条目，使acctPolicySubentry属性出现在
每个user entry里，并且值设置为 “cn=Account Inactivation Policy,ou=Foxconn,dc=cesbg,dc=fii”
ldapadd -x -ZZ -W -D "cn=Directory Manager" -f zjfwl.ldif

dn: cn=DefnCoS,ou=Foxconn,dc=cesbg,dc=fii
objectClass: top
objectClass: ldapsubentry
objectclass: cosSuperDefinition
objectclass: cosPointerDefinition
cosTemplateDn: cn=TempltCoS,ou=Foxconn,dc=cesbg,dc=fii
cosAttribute: acctPolicySubentry default operational-default   

# agreement
root@XTJJSLdap01:/var/log/dirsrv/slapd-389server# dsconf -D "cn=Directory Manager" ldap://XTJJSLdap01.cesbg.fii repl-agmt list --suffix="dc=cesbg,dc=fii"
Enter password for cn=Directory Manager on ldap://XTJJSLdap01.cesbg.fii:
dn: cn=repl163_172,cn=replica,cn=dc\3Dcesbg\2Cdc\3Dfii,cn=mapping tree,cn=config
cn: repl163_172
description: repl163_172
nsDS5ReplicaBindDN: cn=repltj2,cn=config
nsDS5ReplicaBindMethod: simple
nsDS5ReplicaCredentials: {AES-TUhNR0NTcUdTSWIzRFFFRkRUQm1NRVVHQ1NxR1NJYjNEUUVGRERBNEJDUTJNemc1TnpCa05DMDFOMk5rTXpBdw0KT1MwNU1EZGlObVJoTkMxak1XTmxOREExT1FBQ0FRSUNBU0F3Q2dZSUtvWklodmNOQWdjd0hRWUpZSVpJQVdVRA0KQkFFcUJCQVd3bTllSWxGSjM1Vk16bnpQUmRrdg==}O8o5fRaGwFfA5m5hrUIqCw==
nsDS5ReplicaHost: XTJJSLdap02.cesbg.fii
nsDS5ReplicaPort: 636
nsDS5ReplicaRoot: dc=cesbg,dc=fii
nsDS5ReplicaTransportInfo: LDAPS
nsds50ruv: {replicageneration} 632d6d14000000010000
nsds50ruv: {replica 6 ldap://XTJJSLdap02.cesbg.fii:389} 634ad5b2000000060000 63a9648b000200060000
nsds50ruv: {replica 4 ldap://XLHJSLdap02.cesbg.fii:389} 634ad56b000100040000 63a96489ed9300040000
nsds50ruv: {replica 3 ldap://XLHJSLdap01.cesbg.fii:389} 634d7ad6000000030000 63a96486edaf00030000
nsds50ruv: {replica 1 ldap://xygjsldap01.cesbg.fii:389} 632d77ce000000010000 63b7e05b878200010000
nsds50ruv: {replica 2 ldap://xygjsldap02.cesbg.fii:389} 632d74e3000100020000 63b7deee814400020000
nsds50ruv: {replica 5 ldap://XTJJSLdap01.cesbg.fii:389} 634ad5e4000100050000 63b691f2000100050000
nsds5ReplicaEnabled: on
nsds5replicaChangesSentSinceStartup:: MTo0MjQvMCAyOjEvMCA=
nsds5replicaLastInitEnd: 19700101000000Z
nsds5replicaLastInitStart: 19700101000000Z
nsds5replicaLastUpdateEnd: 20230106010255Z
nsds5replicaLastUpdateStart: 20230106010255Z
nsds5replicaLastUpdateStatus: Error (1) Can't acquire busy replica (Unable to acquire replica: the replica is currently being updated by another supplier.)
nsds5replicaLastUpdateStatusJSON: {"state": "amber", "ldap_rc": "0", "ldap_rc_text": "Success", "repl_rc": "1", "repl_rc_text": "replica busy", "date": "2023-01-06T01:03:06Z", "message": "Error (1) Can't acquire busy replica (Unable to acquire replica: the replica is currently being updated by another supplier.)"}
nsds5replicaUpdateInProgress: FALSE
nsds5replicareapactive: 0
nsruvReplicaLastModified: {replica 6 ldap://XTJJSLdap02.cesbg.fii:389} 00000000
nsruvReplicaLastModified: {replica 4 ldap://XLHJSLdap02.cesbg.fii:389} 00000000
nsruvReplicaLastModified: {replica 3 ldap://XLHJSLdap01.cesbg.fii:389} 00000000
nsruvReplicaLastModified: {replica 1 ldap://xygjsldap01.cesbg.fii:389} 00000000
nsruvReplicaLastModified: {replica 2 ldap://xygjsldap02.cesbg.fii:389} 00000000
nsruvReplicaLastModified: {replica 5 ldap://XTJJSLdap01.cesbg.fii:389} 00000000
objectClass: top
objectClass: nsds5replicationagreement


dn: cn=repl163_28,cn=replica,cn=dc\3Dcesbg\2Cdc\3Dfii,cn=mapping tree,cn=config
cn: repl163_28
description: repl163_28
nsDS5ReplicaBindDN: cn=repl3,cn=config
nsDS5ReplicaBindMethod: simple
nsDS5ReplicaCredentials: {AES-TUhNR0NTcUdTSWIzRFFFRkRUQm1NRVVHQ1NxR1NJYjNEUUVGRERBNEJDUTJNemc1TnpCa05DMDFOMk5rTXpBdw0KT1MwNU1EZGlObVJoTkMxak1XTmxOREExT1FBQ0FRSUNBU0F3Q2dZSUtvWklodmNOQWdjd0hRWUpZSVpJQVdVRA0KQkFFcUJCQ2M3Z25EZy9iNkxpZDVPeTRyRmUxWQ==}8ysEonvZC7IYh01K62pj7Q==
nsDS5ReplicaHost: xygjsldap02.cesbg.fii
nsDS5ReplicaPort: 636
nsDS5ReplicaRoot: dc=cesbg,dc=fii
nsDS5ReplicaTransportInfo: LDAPS
nsds5ReplicaEnabled: on
nsds5replicaChangesSentSinceStartup:: MToxOS8wIA==
nsds5replicaLastInitEnd: 19700101000000Z
nsds5replicaLastInitStart: 20230106005624Z
nsds5replicaLastInitStatus: Error (1) Replication error acquiring replica: replica busy
nsds5replicaLastInitStatusJSON: {"state": "red", "ldap_rc": "0", "ldap_rc_text": "Success", "repl_rc": "1", "repl_rc_text": "replica busy", "conn_rc": "0", "conn_rc_text": "operation success", "date": "2023-01-06T00:56:25Z", "message": "Error (1) Replication error acquiring replica: replica busy"}
nsds5replicaLastUpdateEnd: 20230106010257Z
nsds5replicaLastUpdateStart: 20230106010257Z
nsds5replicaLastUpdateStatus: Error (1) Can't acquire busy replica (Unable to acquire replica: the replica is currently being updated by another supplier.)
nsds5replicaLastUpdateStatusJSON: {"state": "amber", "ldap_rc": "0", "ldap_rc_text": "Success", "repl_rc": "1", "repl_rc_text": "replica busy", "date": "2023-01-06T01:03:06Z", "message": "Error (1) Can't acquire busy replica (Unable to acquire replica: the replica is currently being updated by another supplier.)"}
nsds5replicaUpdateInProgress: FALSE
nsds5replicareapactive: 0
objectClass: top
objectClass: nsds5replicationagreement


# 错误日志
[22/Mar/2023:17:23:19.287899912 +0800] conn=72 op=46 MOD dn="uid=demo_user,ou=people,dc=cesbg,dc=fii"
[22/Mar/2023:17:23:19.340744353 +0800] conn=72 op=46 RESULT err=65 tag=103 nentries=0 wtime=0.000187179 optime=0.052877128 etime=0.053055137 - attribute "sn" not allowed     这个用户sn属性不存在

[22/Mar/2023:17:19:51.355459605 +0800] conn=72 op=5 SRCH base="cn=server,cn=plugins,cn=config" scope=0 filter="(objectClass=*)" attrs="hasSubordinates objectClass"            对象不存在 noSuchObject
[22/Mar/2023:17:19:51.355681087 +0800] conn=72 op=5 RESULT err=32 tag=101 nentries=0 wtime=0.000176973 optime=0.000233712 etime=0.000386838

